<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>OGame ACS Splitter - OGotcha Engine</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-[#0b0e14] text-slate-200 font-sans p-4 md:p-10">

<div class="max-w-6xl mx-auto">
    <div class="flex justify-between items-center mb-8 border-b border-slate-800 pb-4">
        <h1 class="text-3xl font-black italic text-white uppercase tracking-tighter">
            ACS <span class="text-blue-500">SPLITTER</span> <span class="text-xs bg-blue-600 text-white px-2 py-1 rounded">OGOTCHA CORE</span>
        </h1>
        <div class="flex gap-2">
            <button id="btnEqual" onclick="setSplitMode('equal')" class="px-4 py-2 text-xs font-bold rounded bg-blue-600 text-white shadow-lg">EQUO</button>
            <button id="btnWeight" onclick="setSplitMode('weight')" class="px-4 py-2 text-xs font-bold rounded bg-slate-800 text-slate-400">PESO FLOTTA</button>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div class="space-y-4">
            <div class="bg-[#161b22] p-6 rounded-lg border border-slate-700">
                <label class="block text-xs font-bold text-blue-400 mb-2 uppercase">Report di Battaglia (Testo Completo)</label>
                <textarea id="crInput" rows="10" class="w-full bg-[#0d1117] border border-slate-800 p-3 rounded text-xs font-mono" placeholder="Incolla qui tutto il testo del report da OGame..."></textarea>
            </div>

            <div class="bg-[#161b22] p-6 rounded-lg border border-slate-700">
                <label class="block text-xs font-bold text-emerald-400 mb-2 uppercase">Messaggi Riciclate (Testo)</label>
                <textarea id="rrInput" rows="6" class="w-full bg-[#0d1117] border border-slate-800 p-3 rounded text-xs font-mono" placeholder="Incolla qui il testo dei messaggi di riciclo..."></textarea>
            </div>

            <button onclick="calculateSplit()" class="w-full bg-blue-600 hover:bg-blue-500 py-4 rounded font-bold text-white transition-all uppercase shadow-xl">
                Genera Logistica Live
            </button>
        </div>

        <div id="resultsArea" class="hidden space-y-6">
            <div class="bg-[#161b22] p-6 rounded-lg border-l-4 border-blue-500 shadow-2xl">
                <h3 class="text-xl font-bold text-white mb-4 italic uppercase">ðŸš€ Piano Trasporti</h3>
                <div id="logisticLogs" class="space-y-3 font-mono text-sm"></div>
            </div>

            <div class="bg-[#161b22] p-6 rounded-lg border border-slate-800">
                <table class="w-full text-left text-xs">
                    <thead>
                        <tr class="text-slate-500 border-b border-slate-800 uppercase font-black">
                            <th class="pb-3">Player</th>
                            <th class="pb-3 text-center">Peso Flotta %</th>
                            <th class="pb-3 text-center">Riciclato</th>
                            <th class="pb-3 text-right">Spettante Totale</th>
                        </tr>
                    </thead>
                    <tbody id="statsTable"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    let splitMode = 'equal';

    function setSplitMode(m) {
        splitMode = m;
        document.getElementById('btnEqual').className = m === 'equal' ? 'px-4 py-2 text-xs font-bold rounded bg-blue-600 text-white' : 'px-4 py-2 text-xs font-bold rounded bg-slate-800 text-slate-400';
        document.getElementById('btnWeight').className = m === 'weight' ? 'px-4 py-2 text-xs font-bold rounded bg-blue-600 text-white' : 'px-4 py-2 text-xs font-bold rounded bg-slate-800 text-slate-400';
    }

    function calculateSplit() {
        const crText = document.getElementById('crInput').value;
        const rrText = document.getElementById('rrInput').value;

        if(!crText || !rrText) return alert("Incolla i testi di Battaglia e Riciclate!");

        let players = {};

        // PARSING NOMI (Logica OGotcha)
        // Estraiamo i nomi reali e cerchiamo di identificare il peso della flotta
        const nameRegex = /([a-zA-Z0-9_-]+)\s+\[\d+:\d+:\d+\]/g;
        let match;
        while ((match = nameRegex.exec(crText)) !== null) {
            let name = match[1];
            if(!players[name]) players[name] = { name: name, loss: 0, fleetValue: 100, rec: 0 };
        }

        // Estrazione perdite e stima peso flotta dal testo
        // Cerchiamo i blocchi di testo dove OGame scrive "Perdite attaccante: X"
        const lossRegex = /Perdite\s+(?:attaccante|difensore):\s*([\d.]+)/gi;
        let lossMatches = [];
        while ((match = lossRegex.exec(crText)) !== null) {
            lossMatches.push(parseInt(match[1].replace(/\./g, '')));
        }
        
        // Distribuiamo le perdite e il peso (basandoci su una stima se il testo Ã¨ parziale)
        Object.keys(players).forEach((name, i) => {
            players[name].loss = lossMatches[i] || 0;
            // Se non abbiamo l'API, usiamo un peso flotta basato sulle perdite + valore fisso
            players[name].fleetValue = (players[name].loss * 5) + 1000000; 
        });

        // PARSING RICICLATE
        const recRegex = /(?:giocatore|da)\s+([a-zA-Z0-9_-]+)\s+ha\s+riciclato\s+([\d.]+)/gi;
        while ((match = recRegex.exec(rrText)) !== null) {
            let name = match[1];
            let val = parseInt(match[2].replace(/\./g, ''));
            if(players[name]) players[name].rec += val;
        }

        renderResults(Object.values(players));
    }

    function renderResults(list) {
        const logs = document.getElementById('logisticLogs');
        const stats = document.getElementById('statsTable');
        logs.innerHTML = ""; stats.innerHTML = "";

        const totalRec = list.reduce((a, b) => a + b.rec, 0);
        const totalLoss = list.reduce((a, b) => a + b.loss, 0);
        const totalFleetValue = list.reduce((a, b) => a + b.fleetValue, 0);
        const profit = totalRec - totalLoss;

        let balances = [];

        list.forEach(p => {
            let profitShare = (splitMode === 'equal') ? 
                (profit / list.length) : 
                (p.fleetValue / totalFleetValue) * profit;

            let target = p.loss + profitShare;
            let diff = p.rec - target;

            stats.innerHTML += `
                <tr class="border-b border-slate-800">
                    <td class="py-4 font-black text-blue-400 uppercase tracking-tighter">${p.name}</td>
                    <td class="text-center text-slate-500">${Math.round((p.fleetValue/totalFleetValue)*100)}%</td>
                    <td class="text-center text-emerald-500 font-mono">${p.rec.toLocaleString()}</td>
                    <td class="text-right font-black text-white">${Math.floor(target).toLocaleString()}</td>
                </tr>`;
            
            balances.push({name: p.name, diff: diff});
        });

        // Generazione trasporti
        let d = balances.filter(x => x.diff > 1000).sort((a,b) => b.diff - a.diff);
        let c = balances.filter(x => x.diff < -1000).sort((a,b) => a.diff - b.diff);

        d.forEach(deb => {
            c.forEach(cred => {
                if(deb.diff > 1000 && cred.diff < -1000) {
                    let move = Math.min(deb.diff, Math.abs(cred.diff));
                    logs.innerHTML += `
                        <div class="p-3 bg-slate-900 border-l-2 border-blue-500 rounded">
                            ðŸšš <b>${deb.name}</b> manda a <b>${cred.name}</b>: <span class="text-blue-400 font-bold">${Math.floor(move).toLocaleString()}</span>
                        </div>`;
                    deb.diff -= move; cred.diff += move;
                }
            });
        });

        document.getElementById('resultsArea').classList.remove('hidden');
    }
</script>
</body>
</html>
