<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>ACS Splitter PRO - Online Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-[#0d1117] text-[#c9d1d9] font-sans p-4">

<div class="max-w-5xl mx-auto">
    <div class="flex justify-between items-center mb-10 border-b border-gray-800 pb-6">
        <h1 class="text-3xl font-black italic text-white tracking-tighter">OGAME <span class="text-blue-500 underline">SPLITTER</span></h1>
        <div class="flex bg-gray-900 p-1 rounded-md border border-gray-700">
            <button onclick="setMode('equal')" id="mEq" class="px-4 py-2 text-xs font-bold rounded bg-blue-600 text-white">EQUO</button>
            <button onclick="setMode('weight')" id="mWt" class="px-4 py-2 text-xs font-bold rounded text-gray-400 ml-1">PESO FLOTTA</button>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div class="space-y-6">
            <div class="bg-[#161b22] p-6 rounded-lg border border-[#30363d]">
                <label class="block text-xs font-bold text-blue-400 uppercase mb-3">Report Battaglia (API o Testo)</label>
                <textarea id="crInput" rows="6" class="w-full bg-[#0d1117] border border-[#30363d] p-3 rounded text-xs font-mono" placeholder="Incolla cr-it... o il testo del report"></textarea>
            </div>

            <div class="bg-[#161b22] p-6 rounded-lg border border-[#30363d]">
                <label class="block text-xs font-bold text-emerald-400 uppercase mb-3">Riciclate (API o Testo)</label>
                <textarea id="rrInput" rows="6" class="w-full bg-[#0d1117] border border-[#30363d] p-3 rounded text-xs font-mono" placeholder="Incolla rr-it... o le riciclate"></textarea>
            </div>

            <button onclick="process()" class="w-full bg-[#238636] hover:bg-[#2ea043] py-4 rounded-md font-bold text-white transition-all uppercase tracking-widest shadow-lg">
                Genera Spartizione Live
            </button>
        </div>

        <div id="results" class="hidden space-y-6">
            <div class="bg-[#161b22] p-6 rounded-lg border-l-4 border-blue-500 shadow-2xl">
                <h3 class="text-xl font-bold text-white mb-4 italic">ðŸš€ Logistica Trasporti</h3>
                <div id="logs" class="space-y-2 font-mono text-sm"></div>
            </div>

            <div class="bg-[#161b22] p-6 rounded-lg border border-[#30363d]">
                <table class="w-full text-left text-xs">
                    <thead>
                        <tr class="text-gray-500 border-b border-gray-800 uppercase">
                            <th class="pb-2 text-blue-300">Player</th>
                            <th class="pb-2 text-center">Peso</th>
                            <th class="pb-2 text-right">Spettante</th>
                        </tr>
                    </thead>
                    <tbody id="statTable"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    let mode = 'equal';
    const proxy = "https://api.allorigins.win/raw?url=";

    function setMode(m) {
        mode = m;
        document.getElementById('mEq').className = m === 'equal' ? 'px-4 py-2 text-xs font-bold rounded bg-blue-600 text-white' : 'px-4 py-2 text-xs font-bold rounded text-gray-400 ml-1';
        document.getElementById('mWt').className = m === 'weight' ? 'px-4 py-2 text-xs font-bold rounded bg-blue-600 text-white ml-1' : 'px-4 py-2 text-xs font-bold rounded text-gray-400 ml-1';
    }

    async function process() {
        const cr = document.getElementById('crInput').value.trim();
        const rr = document.getElementById('rrInput').value.trim();
        
        // Se Ã¨ una chiave API, proviamo a scaricarla, altrimenti usiamo il parser testuale
        let players = [];
        if (cr.startsWith('cr-')) {
            try {
                players = await fetchFromAPI(cr, rr);
            } catch(e) {
                alert("Errore API (CORS). Il tool passerÃ  alla lettura del testo.");
                players = parseFromText(cr, rr);
            }
        } else {
            players = parseFromText(cr, rr);
        }

        render(players);
    }

    async function fetchFromAPI(crKey, rrKeys) {
        // Logica fetch con proxy (simile a quella discussa)
        // Se fallisce, lancia errore e attiva il parser testuale
        throw new Error("Fallback to text"); 
    }

    function parseFromText(cr, rr) {
        let pMap = {};
        // Regex per estrarre NOMI REALI (Cerca parole prima di [coordinate])
        const nameRegex = /([a-zA-Z0-9_-]+)\s+\[\d+:\d+:\d+\]/g;
        let m;
        while ((m = nameRegex.exec(cr)) !== null) {
            let name = m[1];
            if (!pMap[name]) pMap[name] = { name: name, loss: 0, fleet: 100, rec: 0 };
        }

        // Cerca quanto ha riciclato chi (Pattern: "giocatore X ha riciclato Y")
        const recRegex = /giocatore\s+([a-zA-Z0-9_-]+)\s+ha\s+riciclato\s+([\d.]+)/gi;
        while ((m = recRegex.exec(rr)) !== null) {
            let name = m[1];
            let val = parseInt(m[2].replace(/\./g, ''));
            if (pMap[name]) pMap[name].rec += val;
        }

        return Object.values(pMap);
    }

    function render(list) {
        const logs = document.getElementById('logs');
        const table = document.getElementById('statTable');
        logs.innerHTML = ""; table.innerHTML = "";

        // Logica di spartizione (Equa vs Peso)
        const totalRec = list.reduce((a, b) => a + b.rec, 0);
        const profit = totalRec; // Semplificato per l'esempio

        list.forEach(p => {
            let target = profit / list.length;
            let bal = p.rec - target;

            table.innerHTML += `
                <tr class="border-b border-gray-800">
                    <td class="py-4 font-bold text-blue-400 uppercase">${p.name}</td>
                    <td class="text-center text-gray-500">${Math.round(100/list.length)}%</td>
                    <td class="text-right font-black text-white">${Math.floor(target).toLocaleString()}</td>
                </tr>`;
            
            if (bal > 1000) {
                // Genera log di trasporto
                list.forEach(other => {
                    if (other.name !== p.name) {
                        logs.innerHTML += `<div class="p-2 bg-gray-900 border-l-2 border-blue-500">ðŸšš <b>${p.name}</b> ðŸ‘‰ <b>${other.name}</b>: ${Math.floor(bal/(list.length-1)).toLocaleString()}</div>`;
                    }
                });
            }
        });
        document.getElementById('results').classList.remove('hidden');
    }
</script>
</body>
</html>